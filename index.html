<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="author" content="Dmitry Sharabin" />
	<meta name="keywords" content="HTML,CSS,Mavo" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<!-- Mavo -->
	<link rel="stylesheet prefetch" href="https://get.mavo.io/mavo.min.css" />
	<script src="https://get.mavo.io/mavo.min.js"></script>

	<link rel="stylesheet prefetch" href="style.css" />
	<link rel="icon"
		href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">💬</text></svg>' />

	<title>Mavo Chat</title>
</head>

<body>
	<main mv-app="chat" mv-bar="no-status no-save" mv-mode="read" mv-plugins="firebase-firestore markdown"
		mv-storage="firebase://mavo-demos" mv-storage-key="AIzaSyDvZ3EBuhlvFm529vMPeU7dbqvdkjv9WQU"
		mv-storage-providers="twitter facebook google github" mv-storage-options="realtime">

		<div class="mv-bar">
			<h2>Mavo Chat App</h2>
			<button class="mv-firebase-auth-google">Sign in with Google</button>
			<button class="mv-firebase-auth-facebook">Sign in with Facebook</button>
			<button class="mv-firebase-auth-twitter">Sign in with Twitter</button>
			<button class="mv-firebase-auth-github">Sign in with Github</button>
			<button class="mv-logout">Exit</button>
		</div>

		<!-- Logged-in user -->
		<meta property="userId" content="[$user.info.uid]" />
		<meta property="username" content="[$user.name]" />
		<meta property="avatar" content="[$user.avatar]" />

		<section mv-list="messages" mv-initial-items="0">
			<article mv-list-item mv-mode="[mode or read]" class="mv-logged-in [if(sender.uid = userId, 'mine')]">
				<meta property="mode" mv-mode="read" mv-storage="none" />
				<meta property="deleted" mv-mode="read" datatype="boolean" />

				<p property="sender" mv-mode="read">
					<img property="avatar" alt="Avatar" />
					<span property="name"></span>
				</p>

				<p property="message" class="markdown"></p>

				<p class="timestamp" mv-if="$index = 0 or timestamp - $previous.timestamp > hour()" mv-mode="read">
					[month(timestamp, "shortname")]&nbsp;[day(timestamp)],
					<span mv-if="year(timestamp) != year($today)">[year(timestamp)],</span>
					[time(timestamp, "minutes")]
				</p>

				<div class="action-buttons" mv-if="sender.uid = userId and !deleted">
					<button class="edit-button" mv-if="!mode or mode = read" mv-action="set(mode, edit)"
						title="Edit message">✏️</button>
					<button class="edit-button" mv-if="mode = edit" mv-action="set(mode, read) save(true)"
						title="Save changes">💾</button>
					<button class="edit-button" mv-if="mode = edit" mv-action="set(mode, read)"
						title="Don't save changes">🔙</button>

					<button class="mv-delete" mv-action="set(message, '*🚫 This message was deleted.*') set(deleted, true) save()"
						title="Delete message">❌</button>
				</div>
			</article>

		</section>

		<div id="end">
			<!-- 	A hack to scroll to the last message -->
		</div>

		<form class="mv-logged-in" mv-action="
			addif(message.trim() != '',
						group(message: message, sender: group(uid: userId, name: username, avatar: avatar), timestamp: $now),
						messages)
			set(message, '')
			save()
		">
			<input property="message" mv-storage="none" placeholder="Type a message" />
			<input type="submit" value="Send" />
		</form>
	</main>

	<script>
		(async () => {
			await Mavo.ready;

			Mavo.DOMExpression.special.event("$user", {
				type: "mv-login",
				update: (evt) => evt.backend.user ?? {}
			});

			$.bind(document, "mv-load mv-save", () => {
				$("#end").scrollIntoView();
			});
		})();

		function save(editing = false) {
			const app = Mavo.all["chat"];

			if (editing && !app.unsavedChanges) {
				return;
			}

			app.save();
		}
	</script>
</body>

</html>
